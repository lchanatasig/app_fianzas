@model IEnumerable<app_fianzas.Models.SolicitudFianza>

@{
    ViewBag.Title = "Gestión de Solicitudes de Fianza";
    ViewBag.pTitle = "Solicitudes de Fianza";
    ViewBag.pageTitle = "Lista de Solicitudes";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var successMessage = TempData["SuccessMessage"] as string;
    var errorMessage = TempData["ErrorMessage"] as string;
}

@section styles {
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.2.9/css/responsive.bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.dataTables.min.css">
}

<div class="col-xxl-12">
    <div class="card mt-xxl-n5">
        <div class="card shadow-sm">
            <div class="card-header text-white">
                <h2 class="mb-0">Solicitudes de Fianza</h2>
            </div>
            <div class="card-body p-4">
                <table id="solicitudesTable" class="table table-striped dt-responsive nowrap" style="width:100%">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Beneficiario</th>
                            <th>Tipo de Fianza</th>
                            <th>Monto</th>
                            <th>Estado</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var solicitud in Model)
                        {
                            <tr>
                                <td>@solicitud.SolicitudFianzaId</td>
                                <td>@(solicitud.Beneficiario?.NombreBeneficiario ?? "No definido")</td>
                                <td>@(solicitud.TipoFianza?.Nombre ?? "Sin datos")</td>
                                <td>@String.Format("{0:C}", solicitud.MontoFianza)</td>
                                <td>
                                    @switch (solicitud.EstadoFianzaId)
                                    {
                                        case 1:
                                            <span class="badge bg-warning">En espera de aprobación</span>
                                            break;
                                        case 2:
                                            <span class="badge bg-info">Aprobada sin documentación</span>
                                            break;
                                        case 3:
                                            <span class="badge bg-success">Aprobada y documentada</span>
                                            break;
                                        case 4:
                                            <span class="badge bg-success">Liberada</span>
                                            break;
                                        case 5:
                                            <span class="badge bg-danger">Rechazada</span>
                                            break;
                                        default:
                                            <span class="badge bg-secondary">Sin estado</span>
                                            break;
                                    }
                                </td>
                                <td>
                                    @if (solicitud.EstadoFianzaId == 1)
                                    {
                                        <button class="btn btn-secondary btn-sm" disabled>Revisar</button>
                                    }
                                    else if (solicitud.EstadoFianzaId == 2)
                                    {
                                        <button class="btn btn-primary btn-sm"
                                                data-bs-toggle="modal"
                                                data-bs-target="#gestionDocumentosModal"
                                                onclick="abrirModal(@solicitud.SolicitudFianzaId, @solicitud.TipoFianza?.TipoFianzaId, @solicitud.MontoFianza)">
                                            Gestión Documentos
                                        </button>
                                    }
                                    else if (solicitud.EstadoFianzaId == 3)
                                    {
                                        <a href="@Url.Action("DetalleSolicitudFianza", "SolicitudFianza", new { solicitudFianzaId = solicitud.SolicitudFianzaId })" class="btn btn-info btn-sm">
                                            Revisar
                                        </a>
                                    }
                                    else
                                    {
                                        <button class="btn btn-secondary btn-sm" disabled>Sin Acción</button>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Gestión de Documentos -->
<div class="modal fade" id="gestionDocumentosModal" tabindex="-1" aria-labelledby="gestionDocumentosLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="gestionDocumentosLabel">Gestión de Documentos Firmados</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <!-- Sección de descargas -->
                <div>
                    <h6>Descargar Documentos:</h6>
                    <ul id="documentosListaModal">
                        <!-- Se completará dinámicamente en JS -->
                    </ul>
                </div>
                <hr />
                <!-- Formulario para subir documentos -->
                <form id="uploadDocumentsForm" class="needs-validation" novalidate enctype="multipart/form-data">
                    <input type="hidden" id="selectedSolicitudId">
                    <input type="hidden" id="montoSolicitud">
                    <div class="mb-3">
                        <label for="solicitudFile" class="form-label">Solicitud de Fianza (PDF)</label>
                        <input type="file" class="form-control" id="solicitudFile" accept=".pdf" required>
                        <div class="invalid-feedback">Debe subir un archivo en formato PDF.</div>
                    </div>
                    <div class="mb-3">
                        <label for="convenioFile" class="form-label">Convenio de Fianza (PDF)</label>
                        <input type="file" class="form-control" id="convenioFile" accept=".pdf" required>
                        <div class="invalid-feedback">Debe subir un archivo en formato PDF.</div>
                    </div>
                    <div class="mb-3">
                        <label for="pagareFile" class="form-label">Pagaré (PDF)</label>
                        <input type="file" class="form-control" id="pagareFile" accept=".pdf" required>
                        <div class="invalid-feedback">Debe subir un archivo en formato PDF.</div>
                    </div>
                    <!-- Campo para documento adicional si el monto es mayor a 416,000 -->
                    <div class="mb-3 d-none" id="extraDocumentoContainer">
                        <label for="extraDocumentoFile" class="form-label" id="extraDocumentoLabel">Documento Adicional (PDF)</label>
                        <input type="file" class="form-control" id="extraDocumentoFile" accept=".pdf">
                        <div class="invalid-feedback">Debe subir un archivo en formato PDF.</div>
                    </div>
                    <button type="submit" class="btn btn-success w-100">Subir Documentos</button>
                </form>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <!-- jQuery, DataTables y otros scripts necesarios -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.2.9/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.print.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.html5.min.js"></script>

    <script>
        $(document).ready(function () {
            $('#solicitudesTable').DataTable({
                responsive: true,
                pageLength: 5,
                lengthMenu: [5, 10, 20, 50],
                language: {
                    search: "Buscar:",
                    lengthMenu: "Mostrar _MENU_ registros",
                    info: "Mostrando _START_ a _END_ de _TOTAL_ registros",
                    paginate: {
                        first: "Primero",
                        last: "Último",
                        next: "Siguiente",
                        previous: "Anterior"
                    }
                }
            });
        });

        function abrirModal(solicitudId, tipoFianzaId, montoFianza) {
            // Asignar valores a los campos ocultos
            document.getElementById("selectedSolicitudId").value = solicitudId;
            document.getElementById("montoSolicitud").value = montoFianza;

            let documentosLista = document.getElementById("documentosListaModal");

            // Generar dinámicamente los enlaces de descarga según el tipo de fianza
            if (tipoFianzaId === 1) {
                documentosLista.innerHTML = `
                            <li><a href="@Url.Action("DescargarPdf", "SolicitudFianza")?id=${solicitudId}&tipo=fcc" download>Solicitud de Fianza (FCC PDF)</a></li>
                            <li><a href="@Url.Action("DescargarPdf", "SolicitudFianza")?id=${solicitudId}&tipo=fcc&doc=convenio" download>Convenio de Fianza (FCC PDF)</a></li>
                            <li><a href="@Url.Action("DescargarPdf", "SolicitudFianza")?id=${solicitudId}&tipo=fcc&doc=pagare" download>Pagaré (FCC PDF)</a></li>
                        `;
            } else if (tipoFianzaId === 2) {
                documentosLista.innerHTML = `
                            <li><a href="@Url.Action("DescargarPdf", "SolicitudFianza")?id=${solicitudId}&tipo=ga" download>Solicitud de Fianza (GA PDF)</a></li>
                            <li><a href="@Url.Action("DescargarPdf", "SolicitudFianza")?id=${solicitudId}&tipo=ga&doc=convenio" download>Convenio de Fianza (GA PDF)</a></li>
                            <li><a href="@Url.Action("DescargarPdf", "SolicitudFianza")?id=${solicitudId}&tipo=ga&doc=pagare" download>Pagaré (GA PDF)</a></li>
                        `;
            } else if (tipoFianzaId === 3) {
                documentosLista.innerHTML = `
                            <li><a href="@Url.Action("DescargarPdf", "SolicitudFianza")?id=${solicitudId}&tipo=bua" download>Solicitud de Fianza (BUA PDF)</a></li>
                            <li><a href="@Url.Action("DescargarPdf", "SolicitudFianza")?id=${solicitudId}&tipo=bua&doc=convenio" download>Convenio de Fianza (BUA PDF)</a></li>
                            <li><a href="@Url.Action("DescargarPdf", "SolicitudFianza")?id=${solicitudId}&tipo=bua&doc=pagare" download>Pagaré (BUA PDF)</a></li>
                        `;
            } else {
                documentosLista.innerHTML = `
                            <li><a href="#" download>Solicitud de Fianza (PDF)</a></li>
                            <li><a href="#" download>Convenio de Fianza (PDF)</a></li>
                            <li><a href="#" download>Pagaré (PDF)</a></li>
                        `;
            }

            // Si el monto es mayor a 416,000 se muestra el enlace y campo para documento adicional
            if (montoFianza > 416000) {
                documentosLista.innerHTML += `<li><a href="@Url.Action("DescargarPdf", "SolicitudFianza", new { doc = "adicional" })?id=${solicitudId}" download>Documento Adicional (PDF)</a></li>`;
                document.getElementById("extraDocumentoContainer").classList.remove("d-none");
            } else {
                document.getElementById("extraDocumentoContainer").classList.add("d-none");
            }

            // Mostrar el modal (opcional si ya se activa con data-bs-toggle)
            new bootstrap.Modal(document.getElementById("gestionDocumentosModal")).show();
        }

        // Manejo del envío del formulario de documentos
        document.getElementById("uploadDocumentsForm").addEventListener("submit", function (event) {
            event.preventDefault();
            if (!this.checkValidity()) {
                this.classList.add("was-validated");
                return;
            }
            let solicitudId = document.getElementById("selectedSolicitudId").value;
            let montoSolicitud = parseFloat(document.getElementById("montoSolicitud").value) || 0;
            let extraDocumentoFile = document.getElementById("extraDocumentoFile");

            if (montoSolicitud > 416000 && extraDocumentoFile.files.length === 0) {
                alert("Debe subir el documento adicional requerido.");
                return;
            }
            // Aquí podrías realizar el envío vía AJAX o actualizar el estado en el servidor.
            // Para este ejemplo, se simula con una alerta:
            alert(`Documentos de la solicitud ${solicitudId} han sido gestionados correctamente.`);
            bootstrap.Modal.getInstance(document.getElementById("gestionDocumentosModal")).hide();
        });

        $('#gestionDocumentosModal').on('hidden.bs.modal', function () {
            $('.modal-backdrop').remove();
        });

    </script>

    @if (!string.IsNullOrEmpty(successMessage))
    {
        <script>
            Swal.fire({
                title: '¡Éxito!',
                text: '@successMessage',
                icon: 'success',
                confirmButtonText: 'OK',
                timer: 3000
            });
        </script>
    }
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <script>
            Swal.fire({
                title: 'Error!',
                text: '@errorMessage',
                icon: 'error',
                confirmButtonText: 'OK',
                timer: 3000
            });
        </script>
    }
}
